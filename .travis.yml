language: c
matrix:
  include:
    - os: linux
      env: TEST_SUITE=testinstall CFLAGS="-fprofile-arcs -ftest-coverage" LDFLAGS="-fprofile-arcs"
      compiler: gcc
      addons:
        apt_packages:
          - libgmp-dev
#      after_success:
#          - bash <(curl -s https://codecov.io/bash)
    - os: linux
      env: TEST_SUITE=testtravis CFLAGS="-fprofile-arcs -ftest-coverage" LDFLAGS="-fprofile-arcs"
      compiler: gcc
      addons:
        apt_packages:
          - libgmp-dev
#      after_success:
#          - bash <(curl -s https://codecov.io/bash)
    - os: osx
      env: TEST_SUITE=testtravis CFLAGS="-fprofile-arcs -ftest-coverage" LDFLAGS="-fprofile-arcs"
      compiler: clang
      addons:
        apt_packages:
         - libgmp-dev
#      after_success:
#          - bash <(curl -s https://codecov.io/bash)
    - os: linux
      env: TEST_SUITE=testbugfix  CFLAGS="-fprofile-arcs -ftest-coverage" LDFLAGS="-fprofile-arcs"
      compiler: gcc
      addons:
        apt_packages:
         - libgmp-dev
#      after_success:
#          - bash <(curl -s https://codecov.io/bash)
    - os: linux
      env: TEST_SUITE=makemanuals
      compiler: gcc
      addons:
        apt_packages:
         - libgmp-dev
         - texlive-latex-base
         - texlive-latex-recommended
         - texlive-latex-extra
         - texlive-extra-utils
         - texlive-fonts-recommended
         - texlive-fonts-extra
    - os: linux
      env: TEST_SUITE=testtravis ABI=32
      compiler: gcc
      addons: 
        apt_packages:
          - libgmp-dev:i386
          - gcc-multilib
#      after_success:
#          - bash <(curl -s https://codecov.io/bash)

script:
  - git clone --depth=50 https://github.com/gap-system/ward extern/ward
  - ./make.hpc WARD="extern/ward" GMP=system ZMQ=no
  - cd pkg
  - wget ftp://ftp.gap-system.org/pub/gap/gap47/tar.gz/packages/autpgrp-1.5.tar.gz
  - wget ftp://ftp.gap-system.org/pub/gap/gap47/tar.gz/packages/atlasrep1r5p0.tar.gz
  - wget ftp://ftp.gap-system.org/pub/gap/gap47/tar.gz/packages/ctbllib-1r2p2.tar.gz
  - wget ftp://ftp.gap-system.org/pub/gap/gap47/tar.gz/packages/grpconst-2.3.tar.gz
  - wget ftp://ftp.gap-system.org/pub/gap/gap47/tar.gz/packages/irredsol-1r2n4.tar.gz
  - wget ftp://ftp.gap-system.org/pub/gap/gap47/tar.gz/packages/tomlib1r2p4.tar.gz 
  - tar xvzf autpgrp-1.5.tar.gz
  - tar xvzf atlasrep1r5p0.tar.gz
  - tar xvzf ctbllib-1r2p2.tar.gz
  - tar xvzf grpconst-2.3.tar.gz
  - tar xvzf irredsol-1r2n4.tar.gz
  - tar xvzf tomlib1r2p4.tar.gz
  - cd ..
  - echo "Read(\"tst/${TEST_SUITE}.g\"); quit;" | sh bin/gap.sh -S | tee testlog.txt | grep --colour=always -E "########> Diff|$"
  - cat testlog.txt | grep "total"
  - ( ! grep "########> Diff" testlog.txt )

# TODO: merge the above with the master build system (in particular, integrate with codecov
#  - ./configure --with-gmp=system
#  - make config
#  - make -j4
#  - make bootstrap-pkg-full
#  - bash etc/ci.sh
