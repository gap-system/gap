# We want Ubuntu 14.04 "Trust" instead of 12.04 "Precise" to get newer
# and less buggy gcov
dist: trusty
language: c

env:
  global:
    - CFLAGS="-fprofile-arcs -ftest-coverage -O2"
    - LDFLAGS="-fprofile-arcs"
    # CC_TEST_REPORTER_ID for CodeClimate:
    - secure: bAVlSixOUgcNZbby3IN7dh7Hiih+v45l9/R8F6hD0XcYOyaj1OYntqKj+JhS2Nm0zF9B1Ccitbr1biNsrQ+mtraUpCjhyOBa48QC/9zYATX6vkyMrojuBz+80KcU+RecVL5DN43tZrKpo9iU101UPF3wZuDX6TpHVFxz4dYgg2M=

# TODO: boehm GC, HPC-GAP compatibility mode

addons:
  apt_packages:
    - libgmp-dev
    - libreadline-dev
    - libgmp-dev:i386
    - libreadline-dev:i386
    - gcc-multilib
    - g++-multilib
    - texinfo

matrix:
  include:
    # general test suite (subsumes testinstall tests, too)
    - env: TEST_SUITE=testtravis CONFIGFLAGS="--enable-debug"
    - env: TEST_SUITE=testtravis ABI=32

    # OS X builds: since those are slow and limited on Travis, we only run testinstall
    - env: TEST_SUITE=testinstall
      os: osx
      compiler: clang

    # test creating the manual
    - env: TEST_SUITE=makemanuals CONFIGFLAGS="--enable-debug"
      addons:
        apt_packages:
          - texlive-latex-base
          - texlive-latex-recommended
          - texlive-latex-extra
          - texlive-extra-utils
          - texlive-fonts-recommended
          - texlive-fonts-extra

    # run tests contained in the manual
    - env: TEST_SUITE=testmanuals CONFIGFLAGS="--enable-debug"

    # HPC-GAP builds (for efficiency, we don't build all combinations)
    # FIXME: the 32bit build removes -O2 to avoid an internal compiler error for vecgf2.c
    - env: TEST_SUITE=testinstall ABI=64 HPCGAP=yes CONFIGFLAGS="--enable-debug"
    - env: TEST_SUITE=testinstall ABI=32 HPCGAP=yes BUILDDIR=build CONFIGFLAGS="--with-gmp=builtin" CFLAGS="-fprofile-arcs -ftest-coverage"

    # out of tree builds -- these are mainly done to verify that the build
    # system work in this scenario. Since we don't expect the test results to
    # vary compared to the in-tree builds, we turn off coverage reporting by
    # setting NO_COVERAGE=1; this has the extra benefit of also running the
    # tests at least once with the ReproducibleBehaviour option turned off.
    - env: TEST_SUITE=testinstall NO_COVERAGE=1 ABI=64 BUILDDIR=build CONFIGFLAGS="--enable-debug"
    - env: TEST_SUITE=testinstall NO_COVERAGE=1 ABI=32 BUILDDIR=build

    # run bugfix regression tests
    - env: TEST_SUITE=testbugfix CONFIGFLAGS="--enable-debug"

    # test error reporting (quickest job in this test suite)
    - env: TEST_SUITE=testerror CONFIGFLAGS="--enable-debug"

before_script:
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
  - ./cc-test-reporter before-build

script:
  - gcov --version
  - bash etc/ci-prepare.sh
  - bash etc/ci.sh

after_script:
  - bash etc/ci-gather-coverage.sh
  - bash <(curl -s https://codecov.io/bash)
  - ./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT

notifications:
  slack:
    secure: Nvt9q2kZ/n7HyFeEYt7rvXMBLIR3AqSbQ54UeoU2UFrF+y0vJONChfa0csneyXPApH+objSUgS8ZW3g4gRiKtnO1jzQq9XDe895HtadY4vxYrduRLiwqI4o0k9KFVBPX7uIUXT22qIaAYBFC93m36zQKIAVDFzYuPoQfTWY3Yww=
