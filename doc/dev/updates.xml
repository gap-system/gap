
<!-- 

  updates.xml           GAP documentation    

  Copyright (C) 2005,  The GAP Group

Here we document tasks for preparing an update or a full release.

       $Id: updates.xml,v 1.9 2008/09/26 06:48:44 gap Exp $
-->

<Chapter Label="Chap-Updates">
<Heading>Preparing Releases and Updates</Heading>

This chapter documents various tasks for preparing an update of the
officially released version of &GAP;. Large parts of this chapter also
apply to <Q>major releases</Q>. Currently, the main unsolved problem 
with major releases is, how the differences to the previous version 
are properly documented and tested. The wrapping and publication
processes are essentially the same for updates and major releases.

<Section Label="Sect-CommitForRelease">
<Heading>Committing changes for the next update or release</Heading>

As a developer provide your changes for the next official update or major
release in two steps: first commit the code and/or documentation to the 
<Emph>release branch</Emph> of the &GAP; CVS repository; then document
your changes.

<Subsection Label="Ssect-CommitRelBranch">
<Heading>Commiting to the release branch</Heading>

Changes to the &GAP; system are normally first commited to the development
branch of the &GAP; CVS repository. So, in most cases, commiting changes
to the release branch means to transfer some changes from the
development branch.
<P/>

There are two main strategies: Either use a fully checked out release 
branch to introduce changes, or temporarily check out files from the
release branch inside your working copy of the development branch.
<P/>

The relevant CVS  commands are explained in section <Ref
Sect="Sect-BranchCVS" />. 


</Subsection>

<Subsection Label="Ssect-FillUpdate">
<Heading>Document your changes of the release branch</Heading>

To document your changes add an entry to the file <C>4.0/dev/Update</C> in
the development branch. The format of the entries is documented inside
that file, which after an update or release looks as follows:

<Listing Type="file 4.0/dev/Update, when empty"><![CDATA[
<#Include SYSTEM "../../dev/Update.empty">
]]></Listing>

After an update or release the file <C>4.0/dev/Update</C> is copied to a new
file with a name containing the release version, like
<C>4.0/dev/Update4.4.9</C>, and added to the CVS repository to keep a record
of the changes. At the same time the file <C>4.0/dev/Update</C> is reset to
the empty prototype <C>4.0/dev/Update.empty</C>.

<P/>
Do <E>not</E> describe the wrong behaviour in present tense like in:

<P/>
<Q>Function <C>XYZ</C> returns the wrong result when computing <C>ABC</C>.
</Q>

<P/>
Rather, write it like this:

<P/>
<Q>Function <C>XYZ</C> returned the wrong result when computing <C>ABC</C>.
</Q>

<P/>
or

<P/>
<Q>Fixed an error in function <C>XYZ</C> which returned the wrong result when
    computing <C>ABC</C>.</Q>

<P/>
or
<P/>

<Q>Function <C>XYZ</C> now returns the correct result when computing 
    <C>ABC</C>.</Q>

<P/>
Otherwise, it will appear on the web pages as if we knowingly
introduced a new bug.

</Subsection>

</Section>

<Section Label="Sect-Wrapping">
<Heading>Wrapping Archives for a Release or Update</Heading>
<Subsection Label="Ssect-WrapNeeds">
<Heading>What you need to start</Heading>
Here is an overview about the hard- and software needed for the wrapping
process (at least with the currently available scripts and tools).
<List >
<Item>a UNIX/Linux machine</Item>
<Item>a disc partition with at least 1 GB of space</Item>
<Item>the standard <C>sh</C> shell and basic UNIX utilities like <C>cp</C>, 
<C>mv</C> or <C>cmp</C></Item>
<Item><C>cvs</C> and access to the &GAP; CVS repository</Item>
<Item>a &TeX; installation (which can process big files)</Item>
<Item><C>perl</C> (for several manual tools)</Item>
<Item><C>tth</C>, see <URL
Text="http://hutchinson.belmont.ma.us/tth/">http://hutchinson.belmont.ma.us/tth/
</URL></Item>
<Item>a C-compiler and <C>make</C></Item>
<Item><C>zoo</C>, <C>unzoo</C> (from the &GAP; site), <C>tar</C>, 
<C>gzip</C>, <C>bzip2</C>, <C>zip</C>, 
and <C>python</C> (for repacking into the various formats)</Item>
<Item>an installed &GAP;</Item>
<Item>persons who can provide Windows and MacOS binaries of the &GAP;
kernel</Item>
</List>
The following descriptions will explain what has to be done in the
various steps, and will mention some tools which are available in 
the <F>dev/DistributionUpdate/maindist</F> directory of the
CVS repository of the development version. 
</Subsection>

<Subsection Label="Ssect-BeforeWrap">
<Heading>Before the actual wrapping</Heading>
<List >
<Mark>Run tests on release branch.</Mark>
<Item>Before thinking about wrapping apply all the standard tests
described in <Ref Chap="Chap-Testing"/> to a checked out CVS release
branch and make sure there are no problems. (But also do the tests again
later, starting with the archives which are actually delivered to the
users!)</Item>
<Mark>Adjust version numbers.</Mark>
<Item>Version numbers must be adjusted in the <E>CVS release branch</E> in the
following files:
<List >
<Item><F>lib/system.g</F>, see <C>Version</C>, <C>Date</C> and
<C>NeedKernelVersion</C></Item>
<Item><F>src/system.c</F>, see <C>KernelVersion</C> and <C>SyWindowsPath</C>
(the latter only changes with main releases)</Item>
<Item><F>doc/build/config.install</F>, see <C>versionnumber</C>,
<C>versionsuffix</C> and <C>releaseday</C></Item>
</List>
Do not forget to commit the changes to the CVS repository. Of course,
if the release turns out to be delayed the two dates may need to be
adjusted again.
</Item>

<Mark>Edit variables in <F>setvar</F>.</Mark>
<Item>
Some basic variables for the scripts used below are set in the file
<F>dev/DistributionUpdate/maindist/setvar</F>. Choose a directory
for the wrapping which can hold at least 1 GB of data (specify as 
<C>DISTROOT</C>). Adjust some version numbers and strings (some
conventions, say we want to wrap version 4.5.2: the CVS release branch
should be tagged <C>GAP4R5</C>, the names of the main archives start
with <F>gap4r5p2</F>, the paths in the main archive start with <F>gap4r5</F>,
and for updates the differences to previous versions
of the same main release are in <F>fix4r5p2</F>). Find the URL of the
current merged package archive from the &GAP; website.
</Item>

<Mark>Extract test code from <F>Update</F> file.</Mark>
<Item>
Changes from previous versions are described in the CVS file
<F>dev/Update</F>, as mentioned in <Ref Subsect="Ssect-FillUpdate"/>.
Usually, this step has to be repeated if several wrapping attempts are
necessary; it can be left out while the wrapped archives are not yet
expected to become release candidates.
<P/>
Extract test code from <F>dev/Update</F> into <F>tst/bugfix.tst</F> 
of the release branch (and of the development branch as well)
and commit to CVS.  E.g., within the 
<F>dev/DistributionUpdate/maindist</F> there is a file <F>Update.g</F>;
start <C>gap</C>, read this file, say
<Listing Type="GAP input">
d := UpdateData("../../Update");;
l := FixesAndOthersData(d);;
PrintTestLines("guck.tst", l);
</Listing>
then the file <F>guck.tst</F> contains the new test lines.
<P/>
Note that the test code should be added to <F>tst/bugfix.tst</F>
before the tests (see Chapter &nbsp;<Ref Chap="Chap-Testing"/>)
are run on the test candidate.
</Item>

<Mark>Extract description of changes from <F>Update</F> file.</Mark>
<Item>
Only do this step before you hope to wrap a release candidate.
(You may need some help by someone who knows about managing the &GAP; 
website.)
<P/>
Create and add a file like <F>description4r5p2</F> in the main directory of
the new distribution. Its content is created from the <C>!Description</C>
entries of the <F>dev/Update</F> file. At the same time the webpage
describing the changes is prepared. Before doing this add Mixer/XHTML markup to
these entries as appropriate, in particular links to the documentation
of changed or new functions can be sensible.
<P/>
To extract the entries from the <F>dev/Update</F> file and roughly sort
them into several categories you can proceed similarly as with extracting
the test lines: Start <C>gap</C>, read <F>Util.g</F>, say
<Listing Type="GAP input">
d := UpdateData("../../Update");;
l := FixesAndOthersData(d);;
PrintDescriptionLines("guck.mixer", l);
</Listing>
then the file <F>guck.mixer</F> can be copied into the template 
<F>gap4rXpY.mixer.template</F> in the  CVS directory of the website
<F>WWW2/Download/Updates</F> to create a new file like <F>gap4r5p2.mixer</F>.
Maybe reorder the entries a bit such that those which are likely to be
interesting for more &GAP; users are closer to the top of each category.
<P/>
Then call the <C>mixer</C> on the new file and produce a text version of
the resulting HTML file, say with <C>w3m -dump gap4r5p2.html</C>. 
Edit this result to get the <F>description4r5p2</F> file for the release
branch.
</Item>
</List>
</Subsection>

<Subsection Label="Ssect-Wrap">
<Heading>Wrapping the archives</Heading>
Now we explain how to wrap the archives. The  &GAP; binaries
for Windows and MacOS are added in the end, this can be left out until a
release candidate is wrapped. The following steps produce the
&GAP;-traditional <C>.zoo</C> files with comments saying which files are
text- and which are binary-files.
<P/>
There is a utility <F>dev/DistributionUpdate/maindist/repack.py</F>
which can be used to produce the other archive formats (<C>.tar.gz</C>,
<C>.tar.bz2</C>, <C>-win.zip</C>) from the <C>.zoo</C> archives.
<P/>
The scripts below are started from within the
<F>dev/DistributionUpdate/maindist/</F> directory of the development
version.
<Enum >
<Item>Use <F>./checkout</F> to get current files from repository (if necessary,
first login to the CVS repository, see <Ref Chap="Chap-CVS"/>) as well as 
the content of the current packages archive. (The files are copied into
the wrapping directory specified in <F>setvar</F>.)</Item>
<Item>Compile the documentation with <F>./makedoc</F>. (The packages
archives were unpacked in the previous steps to allow resolving links
into package manuals here.) 
<P/>
This writes files <F>make_doc.log</F> and 
<F>make_doc.error</F> in the root 
directory of the wrapping - check these! (for convenience, in the end of
<F>make_doc.log</F>
there are the lines on over/underfull boxes and undefined references
from the latest manual.log files). If any problems show up, correct
them, commit changes and start over from the previous step.
<P/>
Note that the HTML version of the manual is produced twice, one time 
the result is almost following the HTML 4 standard, and one time it
displays well with the Windows Internet Explorer.
</Item>
<Item>Create completion files with <F>./completionfiles</F>. 
For this the &GAP; kernel will be compiled with the standard
<C>configure; make</C> commands, check that there are no errors 
or warnings during the compilation. 
</Item>
<Item>Use the script <F>./fixpermissions</F>. This gives directories 
<C>755</C>-permissions and files <C>644</C>-permissions, in the end
a few explicitly listed executable files get <C>755</C>-permissions.
Note that the latter list must be adjusted if new executable files are
added to the &GAP; distribution.</Item>
<Item>Now the <C>.zoo</C>-archives can be wrapped with <F>./zooandtag</F> and
<F>./zooandtagdata</F>. This produces the main archive as well as the 
<F>htmie...</F> and <F>tools...</F> archives.
Each file is packed with a comment <C>!TEXT!</C> or <C>!BINARY!</C> 
(to manage line break syntax on different operating systems).
<P/>
The two mentioned scripts include explicit lists of the files to be
wrapped. Most files are included via recursively included directories. 
So, as long as new files or directories for the distribution are put
below some already included directories no change is necessary here.
New executable files should go into the <F>bin</F> directory and must be
added to the scripts. New files in the CVS repository which should not
be distributed should be put in or below the <F>dev</F> directory.
</Item>
<Item>Only for GAP4R4: add the <C>TomLib</C> package which is not yet
completely separated by the script <F>./addtomlib4.4</F>. This adds the
main part of <C>TomLib</C> to the main archive and creates an archive
<F>xtom1r1p2.zoo</F> with the optional data.</Item>
<Item>To produce the Windows executable use the script <F>./winbin</F> and 
follow the instructions which are printed on the screen. 
You need a computer with
Windows and the <C>cygwin</C>-tools installed, for some more details see
<Ref Subsect="Ssect-Cygwin"/> below.</Item>
<Item>
Only for update releases (and only if the main archive is a release
candidate): 
Create an archive <F>fix...</F> with all files which have changed
compared to one of the previous minor releases since the last main
release. For this:
<List>
<Item>Get copies of old <F>gap4r...zoo</F> archives since the last main
release (they should be kept on the &GAP; ftp-server).</Item>
<Item>Check which files have changed from former versions or which are
new.</Item>
<Item>Check which files are no longer in the release version.</Item>
<Item>
Create a new archive, with a name like <F>fix4r5p2.zoo</F>, containing 
all new and changed files, and maybe containing empty files with the
names of files deleted from the distribution (we cannot delete files by
unpacking).
<P/>
Note that in the <F>fix...</F>-archive all paths must be stripped by
their first part (since <F>fix...</F>-archives are unpacked inside the
main &GAP; installation directory).
</Item>
</List>
In <F>dev/DistributionUpdate/maindist/</F> there is a utility
file <F>DiffFiles.g</F> which does this. Start <C>gap</C>, read
<F>DiffFiles.g</F> and use a command like
<P/>
<Listing Type="GAP input">
CreateDiffsArchive("/buildpath/gap4r4p5.zoo",
               ["/oldarchs/gap4r4p2.zoo", "/oldarchs/gap4r4p3.zoo", 
                                          "/oldarchs/gap4r4p4.zoo"],
               "/tmpzoo", 
               "fix4r4p5.zoo", 
               "gap4r4/", 
               ["GAP 4 PPC", "gap4r4/description4"] );
</Listing>
to create the <F>fix...zoo</F> archive with the correct comments. 
(Meaning of the arguments of <C>CreateDiffsArchive</C>: 
new main zoo-archive, list of old zoo-archives, temporary directory, 
name of result archive, part of path to be stripped, missing files which
should not be overwritten by empty ones.) The resulting <F>fix...zoo</F>
archive is in the given temporary directory (which can be the wrapping
directory, otherwise move this archive to the wrapping directory).
</Item>
<Item>Now create the other archive types using the 
<F>repack.py</F> utility. This can be done with <F>./repack</F>.</Item>
<Item>
Ask Burkhard Höfling (<C>Familie Höfling
&lt;B.Hoefling@tu-bs.de&gt;</C>) to provide a MacOS executable of the
&GAP; kernel in the release branch (if the kernel has changed, otherwise
get it from the previous release). Copy the file <F>GAP 4 PPC</F> to
the wrapping directory and use <F>./macbin</F> to add it to the main 
<C>.zoo</C> archive (it should not be included in the archives of other
formats). In case of an update also add it to the <C>.zoo</C> version 
of the <F>fix4...</F> archive with <F>./macbinfix</F>. (This file gets
the comment <C>!MACBINARY!</C>.)
</Item>

</Enum>

To give a rough idea, once the Windows and MacOS executables are
available and the <F>dev/Update</F> file, and so <F>tst/bugfix.tst</F> and
<F>description...</F>, are stable the wrapping described above is fully
automatic and takes about 20 minutes (varies with the network connection
to the CVS repository and the speed of the machine for the repacking). 
<P/>
Now take these archives and test them on as many different systems as
possible. Recall the test suites described in <Ref Chap="Chap-Testing"/>.
<!--<P/>
When the archives are actually released, tag the files in the CVS release
branch with a command like (within the top directory of a checked 
out release version): <C>cvs tag GAP4R5P2 .</C> -->
</Subsection>

<Subsection Label="Ssect-Cygwin">
<Heading>Compiling on Windows with Cygwin</Heading>

The script <F>winbin</F> mentioned earlier gives you an archive
<F>wincode.tgz</F> containing the following files from the
distribution (using shell globbing syntax):

<Listing>
    src/* cnf/* configure configure.in Makefile.in sysinfo.in gap.shi </Listing>

To produce Windows executables you need an installed cygwin environment
(see <URL>http://www.cygwin.com/</URL>). Unpack the archive <F>wincode.tgz</F>
into an empty directory (for example <F>gap4r4</F>) using
<Listing>
    mkdir gap4r4
    cd gap4r4
    tar xzf ../wincode.tgz </Listing>
Then you can compile and link the binaries by doing
<Listing>
     ./configure
     make
     strip bin/i686-pc-cygwin-gcc/gap.exe
     cp bin/i686-pc-cygwin-gcc/gap.exe bin/gapw95.exe
     cp /bin/cygwin1.dll bin
     tar czf ../winbin.tgz bin/gapw95.exe bin/cygwin1.dll</Listing>
 The resulting archive <F>winbin.tgz</F> then contains the executable
 <F>bin/gapw95.exe</F> and the cygwin library <F>bin/cygwin1.dll</F>, 
 which are distributed together with &GAP;. <P/>

Note that there is a nasty problem with respect to dynamically linked 
libraries used by cygwin under Windows: There seems to be no working version
bookkeeping with DLLs. That is, &GAP; might not be working on Windows
systems where another version than the version against which the &GAP; 
executable was linked is installed (at least as long as a process is
running that uses the other version of <F>cygwin1.dll</F>). However,
I do not see a clean solution to this problem.

</Subsection>
</Section>

<Section Label="Sect-Releasing">
<Heading>Releasing a new version</Heading>

After all archives are wrapped and checked and no more errors are found,
one has to do the following things to properly give out the release:

<Enum>
<Item>
    Install the new version yourself (one needs to have this during the
    next few steps). Also create the documentation. You probably can use
    your checked out tree with created documentation. Do not forget unpacking
    the current packages archive. \textbf{Do not use} the versions of the
    packages in CVS! Use the released versions of the packages.
</Item>
<Item>
    For the links on the web pages into the manual:
    Recreate <F>WWW2/lib/AllLinksOfAllHelpSections.data</F> using the to be 
    released version together with the latest packages-Archive using
    <F>4.0/dev/LinksOfAllHelpSections.g</F>. Check this in to CVS.
</Item>
<Item>
    Copy the complete <F>doc</F> directory (of your installation) to the web 
    page under <F>WWW2/Manuals/doc</F> such that manual links work.
</Item>
<Item> Change <F>WWW2/lib/config</F> to reflect the version numbers.
</Item>
<Item>
    Change <F>WWW2/Download/index.mixer</F>:
    Links and names of the archives (version number) and file sizes have
    to be adjusted manually. The GAP banner on the page should reflect 
    the new version.
</Item>
<Item>
    Change <F>WWW2/Download/Updates/index.mixer</F>:
    Add new entry for new revision with a link.
</Item>
<Item>
    Change <F>WWW2/Download/Updates/tree</F>:
    Add new entry for new revision in tree.
</Item>
<Item>
    Finalize <F>WWW2/Download/Updates/gap4rXpY.mixer</F> by using the
    descriptions extracted from the <F>Update</F> file (see above). Maybe
    do a bit of hand editing to improve the order of the issues.
</Item>
<Item>
    Move archives to ftp server, distributed into directories by archive type.
</Item>
<Item>
    Publish web pages, the following files are subject to change and will
    have to be published (for necessary changes see above):

    <List>
        <Item> <F>WWW2/lib/AllLinksOfAllHelpSections.data</F> </Item>
        <Item> <F>WWW2/lib/config</F> </Item>
        <Item> <F>WWW2/Download/index.mixer</F> </Item>
        <Item> <F>WWW2/Download/Updates/tree</F> </Item>
        <Item> <F>WWW2/Download/Updates/index.mixer</F> </Item>
        <Item> <F>WWW2/Download/Updates/gap4rXpY.mixer</F> </Item>
        <Item> <F>WWW2/Download/upgrade.mixer</F> </Item>    
     </List>
     The last file only has to be adjusted, if the table of marks package
     was changed.
</Item>
<Item> 
    Update search facilities on web page: Do on yin:<P/>

    <Listing>
     cd /gap/WWW/Search
     make </Listing>
</Item>
<Item>
     Tag whole tree with GAP4RxPy where x and y are numbers:

     <Listing>
      cvs tag GAP4RxPy .  </Listing>

     in a checked out GAP4R4-branch (without pkg directory!).
</Item>
<Item>
    See to <F>4.0/dev/Update</F> file:

    <List>
        <Item> Copy <F>4.0/dev/Update</F> to <F>4.0/dev/Update4.X.Y</F></Item>
        <Item> Copy <F>4.0/dev/Update.empty</F> to <F>4.0/dev/Update</F></Item>
    </List>

     and put things into cvs (add and commit).
</Item>
<Item>
    Test download and proofread web pages.
</Item>
<Item>
    Announce the new version in the forum.
</Item>
</Enum>
</Section>

</Chapter>

